---
title: "Data Preprocessing"
author:
  - name: "Mike Johnson"
    url: https://github.com/mikejohnson51
    affiliation: Lynker, NOAA-Affilate
    affiliation_url: https://lynker.com
output: distill::distill_article
vignette: >
  %\VignetteIndexEntry{intro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
library(FHGestimation)
library(ggplot2)
library(patchwork)
library(dplyr)
```

# NWIS Filtering Functions

Often the NWIS that comes from long records of steam observation are noisy. Noise can come from changes in the river itself, changes in measurement methods, or even measurement locations.

While the FHG algorithm implemented in this package can deal with this noise through the hybrid the `OLS --> NLS --> NSGA2 --> combo` fitting method, it is also possible, and in some cases even advisable, to filter the NWIS prior to fitting.

Here we will illustrate the packaged methods. Of note, a safety catch applied to _all_ filtering methods is that if it reduces the NWIS set to less then 10 observations, a warning is emitted and the unaltered input NWIS is returned.

## 1. Median Absolute Deviation (mad)

An iterative outlier detection procedure can be run iteratively on the residuals of linear regressions for each relationship following the procedure described in the [HyG nwisset](https://zenodo.org/record/7868764). Values of log-transformed TW, V, and Y residuals falling outside a specified median absolute deviation (MAD) are excluded with each pass until no outliers are left.

This approach can be implemented using `mad_filter`:

```{r}
mad_nwis = FHGestimation::mad_filter(nwis, envelope = 3)
```

```{r, echo = FALSE, out.width="100%"}
ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = Y),
                      color = "black") +
  ggplot2::geom_point(data = mad_nwis, ggplot2::aes(x = Q, y = Y), color = "red") +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = TW),
                      color = "black") +
  ggplot2::geom_point(
    data = mad_nwis,
    ggplot2::aes(x = Q, y = TW),
    color = "red",
    alpha = .5
  ) +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = V),
                      color = "black") +
  ggplot2::geom_point(
    data = mad_nwis,
    ggplot2::aes(x = Q, y = V),
    color = "red",
    alpha = .5
  )
```

## 2. Temporal

Rivers change with time. To minimize the effects of long-term channel evolution it can be advantageous to limit the records to the most recent years. This approach can be implemented using `date_filter`. Users can specify the number of years to keep (in reference to the most recent observation) and whether the maximum flow value should be kept regradless of when it was taken.

```{r}
date_data = FHGestimation::date_filter(nwis, years = 5, keep_max = TRUE)
```

```{r, echo = FALSE, out.width="100%"}
ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = Y),
                      color = "black") +
  ggplot2::geom_point(data = date_data, aes(x = Q, y = Y), color = "red") +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = TW),
                      color = "black") +
  ggplot2::geom_point(data = date_data,
                      aes(x = Q, y = TW),
                      color = "red",
                      alpha = .5) +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = V),
                      color = "black") +
  ggplot2::geom_point(
    data = date_data,
    ggplot2::aes(x = Q, y = V),
    color = "red",
    alpha = .5
  )
```

## 3. Q = vA Assumption

One of the basic assumptions of the AHG relation is that Q = vA where v is velocity, A is cross sectional area, and Q is stream flow. The `qva_filter` can be used to remove measurements that grossly violate this assumption. Within the code, A is assumed to be the product of Y and TW and an allowance can be specific that determines the amount of allows deviation from equality. The default allowance is .05.
 
```{r}
qva_nwis = FHGestimation::qva_filter(nwis, allowance = .05)
```

```{r, echo = FALSE, out.width="100%"}
ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = Y),
                      color = "black") +
  ggplot2::geom_point(data = qva_nwis, ggplot2::aes(x = Q, y = Y), color = "red") +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = TW),
                      color = "black") +
  ggplot2::geom_point(
    data = qva_nwis,
    ggplot2::aes(x = Q, y = TW),
    color = "red",
    alpha = .5
  ) +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = V),
                      color = "black") +
  ggplot2::geom_point(
    data = qva_nwis,
    ggplot2::aes(x = Q, y = V),
    color = "red",
    alpha = .5
  )
```

## 4. NLS prediciton

Through out the development of this package it became evident that the NLS approach, when using OLS estimates as seeds, provided the best relation by relation fit. This approach fits the NLS equations for each provided relationship. This fit is used to predict [V,TW,Y] for all given Q's.  If the actual value is outside the specified allowance (default = +/- 50%) it is removed.

```{r}
nls_nwis = FHGestimation::nls_filter(nwis, allowance = .5)
```

```{r, echo = FALSE, out.width="100%"}
ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = Y),
                      color = "black") +
  ggplot2::geom_point(data = nls_nwis, ggplot2::aes(x = Q, y = Y), color = "red") +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = TW),
                      color = "black") +
  ggplot2::geom_point(
    data = nls_nwis,
    ggplot2::aes(x = Q, y = TW),
    color = "red",
    alpha = .5
  ) +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = V),
                      color = "black") +
  ggplot2::geom_point(
    data = nls_nwis,
    ggplot2::aes(x = Q, y = V),
    color = "red",
    alpha = .5
  )
```

# Chaining Commands

Multiple filtering approaches can be chained together to isolate a representative NWIS set from the complete archive. For example, we could reduce the complete NWIS set to a 10 year record that respects the Q=vA assumption and has no NWIS outside of 3 MAD in any relation:

```{r}
xf = nwis %>% 
  # Keep the most recent 10 year
  FHGestimation::date_filter(year = 10, keep_max = TRUE) %>% 
  # Keep NWIS within 3 Median absolute deviations (log residuals)
  FHGestimation::mad_filter() %>% 
  # Keep NWIS that respects the Q = vA criteria w/in allowance
  FHGestimation::qva_filter()
```

```{r, echo = FALSE, out.width="100%"}
ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = Y),
                      color = "black") +
  ggplot2::geom_point(data = xf, ggplot2::aes(x = Q, y = Y), color = "red") +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = TW),
                      color = "black") +
  ggplot2::geom_point(data = xf,
                      ggplot2::aes(x = Q, y = TW),
                      color = "red") +
  ggplot2::ggplot() +
  ggplot2::geom_point(data = nwis,
                      ggplot2::aes(x = Q, y = V),
                      color = "black") +
  ggplot2::geom_point(data = xf, ggplot2::aes(x = Q, y = V), color = "red")
```

# Example(s)

```{r}
# Best attempt to mimic the HyG nwisset
hf_df = nwis %>%
  FHGestimation::date_filter(5, keep_max = TRUE) %>%
  FHGestimation::qva_filter(allowance = .05) %>%
  FHGestimation::mad_filter(envelope = 3)

# NLS basec filtering
nls_df = nwis %>%
  FHGestimation::date_filter(10, keep_max = TRUE) %>%
  FHGestimation::nls_filter(allowance = .5)

x1 = FHGestimation::fhg_estimate(df = nwis)
x2 = FHGestimation::fhg_estimate(df = hf_df)
x3 = FHGestimation::fhg_estimate(df = nls_df)
```

```{r, echo = FALSE, out.width="100%"}
ggplot2::ggplot() +
  ggplot2::geom_point(ggplot2::aes(x = nwis$Q, y = nwis$Y, color = "FHG"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x = nwis$Q,
    y = (x1$Y_coef[1] * nwis$Q ^ (x1$Y_exp[1])),
    color = "FHG"
  )) +
  ggplot2::geom_point(ggplot2::aes(x = hf_df$Q, y = hf_df$Y, color = "HY"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x  = hf_df$Q,
    y = (x2$Y_coef[1] * hf_df$Q ^ (x2$Y_exp[1])),
    color = "HY"
  )) +
  ggplot2::geom_point(ggplot2::aes(x = nls_df$Q, y = nls_df$Y, color = "NLS"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x  = nls_df$Q,
    y = (x3$Y_coef[1] * nls_df$Q ^ (x3$Y_exp[1])),
    color = "NLS"
  )) +
  ggplot2::theme_light()  +
  ggplot2::labs(
    title = 'Q-Y Relationship',
    color = "Legend",
    y = "Y",
    x = ""
  ) +
  ggplot2::scale_color_manual(values = c(
    "NLS" = "blue",
    "HY" = "red",
    "FHG" = "black"
  )) +
  
  ggplot2::ggplot() +
  ggplot2::geom_point(ggplot2::aes(x = nwis$Q, y = nwis$V, color = "FHG"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x = nwis$Q,
    y = (x1$V_coef[1] * nwis$Q ^ (x1$V_exp[1])),
    color = "FHG"
  )) +
  ggplot2::geom_point(ggplot2::aes(x = hf_df$Q, y = hf_df$V, color = "HY"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x  = hf_df$Q,
    y = (x2$V_coef[1] * hf_df$Q ^ (x2$V_exp[1])),
    color = "HY"
  )) +
  ggplot2::geom_point(ggplot2::aes(x = nls_df$Q, y = nls_df$V, color = "NLS"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x  = nls_df$Q,
    y = (x3$V_coef[1] * nls_df$Q ^ (x3$V_exp[1])),
    color = "NLS"
  )) +
  ggplot2::theme_light()  +
  ggplot2::labs(
    title = 'Q-V Relationship',
    color = "Legend",
    y = "V",
    x = "Q"
  ) +
  ggplot2::scale_color_manual(values = c(
    "NLS" = "blue",
    "HY" = "red",
    "FHG" = "black"
  )) +
  
  ggplot2::ggplot() +
  ggplot2::geom_point(ggplot2::aes(x = nwis$Q, y = nwis$TW, color = "FHG"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x = nwis$Q,
    y = (x1$TW_coef[1] * nwis$Q ^ (x1$TW_exp[1])),
    color = "FHG"
  )) +
  ggplot2::geom_point(ggplot2::aes(x = hf_df$Q, y = hf_df$TW, color = "HV"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x  = hf_df$Q,
    y = (x2$TW_coef[1] * hf_df$Q ^ (x2$TW_exp[1])),
    color = "HY"
  )) +
  ggplot2::geom_point(ggplot2::aes(x = nls_df$Q, y = nls_df$TW, color = "NLS"), alpha = .3) +
  ggplot2::geom_line(ggplot2::aes(
    x  = nls_df$Q,
    y = (x3$TW_coef[1] * nls_df$Q ^ (x3$TW_exp[1])),
    color = "NLS"
  )) +
  ggplot2::theme_light()  +
  ggplot2::labs(
    title = 'Q-TW Relationship',
    color = "Legend",
    y = "TW",
    x = ""
  ) +
  ggplot2::scale_color_manual(values = c(
    "NLS" = "blue",
    "HY" = "red",
    "FHG" = "black"
  ))  +
  patchwork::plot_layout(guides = "collect") &
  ggplot2::theme(legend.position = 'bottom')
```

# Significance

The relationship between all supplied log transformed variables are computed.  If the p-value of any of these is less then the supplied p-value an error message is emitted and it can be assumed that no statistical relationship exists between Q-{TW,V,Y}.

```{r}
s = FHGestimation::significance_check(nwis)
s
```

