---
title: "Traditional AHG fitting"
author:
  - name: "Mike Johnson"
    url: https://github.com/mikejohnson51
    affiliation: Lynker, NOAA-Affiliate
    affiliation_url: https://lynker.com
output: distill::distill_article
vignette: >
  %\VignetteIndexEntry{ahg}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(ggplot2)
library(dplyr)
library(FHGestimation)
```

# The AHG relationships

The idea of hydraulic geometry was introduced by [Leopold and Maddock (1953)](https://books.google.com/books?hl=en&lr=&id=K496gE_YsJoC&oi=fnd&pg=PA1&dq=Leopold+and+Maddock+hydraulic+geometry&ots=FjsEDxo5Ci&sig=vysaOxNq0Y9RSDeZpASbHaQHs6E) and the concept of 'at-a-station hydraulic geometry' (AHG) provides three power laws that relate water-surface width (TW), average depth (Y), and average velocity (V) to the stream flow (Q) in a given river cross section:

$$
TW = a *Q^b
$$
$$
Y = c*Q^f
$$
$$
V = k*Q^m
$$

A set of AHG relations applies to within-bank flows at a
specific cross section and assumes steady-state flow and the channel characteristics do not change sensibly with discharge. Under these assumptions, continuity dictates that no water is gained or lost in the system such that:

$$
Q = TW路Y路V
$$

and therefore:

$$
b + f + m =  a路c路k = 1 
$$

In practice, the enforcement of continuity is determined by the quality of the data, and is not enforced in the estimation of the AHG relationships.

## Traditional Fitting Technique

While the AHG power laws provide an elegant theory for representing a mass-constrained hydraulic system, the data available to determine these relations are rarely as clean. In most cases, hydraulic data is reported as a table(s) relating values of Q to values of one or more hydraulic variables. Thus, the relationships require the power law relationships to be fit,

AHG relations are historically fit using OLS on the logarithmic transformation of the variables, where the exponential of the intercept provides the power law coefficient, and the slope of the linear model provides the exponent. Several studies have highlighted the potential problem of using this approach [38] given that when the log transformed values are back-transformed,the estimates are effectively medians, and not means of the estimates, resulting in a general low bias.

## Example: 

```{r}
data = nwis

fit = lm(log(data$Y) ~ log(data$Q))
  
(coef = exp(fit$coefficients[1]))

(exp  = fit$coefficients[2])
```

```{r, echo = FALSE}

data$Yp = coef * (data$Q ^ exp)
ggplot(data) + 
  geom_point(aes(x = Q, y = Y)) + 
  geom_line(aes(x = Q, y = Yp), color = "red") + 
  theme_light() + 
  labs(x = "Q", y  = "Y")
```

### Full Fits

```{r}
ols = function(X, Y, name = NA){
  fit = lm(log(Y) ~ log(X))
  data.frame(coef = exp(fit$coefficients[1]),
             exp  = fit$coefficients[2],
             name = name,
             row.names = NULL)
}

(x = bind_rows(
        ols(data$Q, data$Y, "Y"),
        ols(data$Q, data$TW, "TW"),
        ols(data$Q, data$V, "V")))
```

###  Continuity check

```{r}
sum(x$exp) 
prod(x$coef)
```

### System Error

```{r}
data = data %>% 
  mutate(Yp  = x$coef[1] * (Q ^ x$exp[1]),
         TWp = x$coef[2] * (Q ^ x$exp[2]),
         Vp  = x$coef[3] * (Q ^ x$exp[3]))
         
err = data.frame(
  Ye  = nrmse(data$Y, data$Yp),
  TWe = nrmse(data$TW, data$TWp),
  Ve  = nrmse(data$V, data$Vp)
) %>% 
  mutate(tot_error = Ye + TWe + Ve, type = "OLS") 
```

```{r, echo = FALSE}
err = err %>% 
  tidyr::pivot_longer(-type)


ggplot() + 
  geom_col(data = err, aes(x = name, y = value)) + 
  theme_light() + labs(x = "Relationship", y = "nRMSE")
```