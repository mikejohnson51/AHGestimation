<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Compute AHG fits from river measurements.">
<title>Computing robust, mass preserving hydraulic geometries and rating curves • AHGestimation</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Computing robust, mass preserving hydraulic geometries and rating curves">
<meta property="og:description" content="Compute AHG fits from river measurements.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">AHGestimation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="articles/index.html">Articles</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mikejohnson51/AHGestimation/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9">
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("remotes")</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_packages</span><span class="op">(</span><span class="st">"mikejohnson51/AHGestimation"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level1">
<div class="page-header"><h1 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h1></div>
<p>The behavior of a river system at a location can be represented as the relationship between discharge (Q), mean depth (Y), mean velocity (V), and mean top width (TW). If you have these measurements over a long period of time, a relationship between how much water (Q) is in the channel and the corresponding Y, V, and TW can be established. The idea of ‘at-a-station hydraulic geometry’ (AHG) suggests three power laws can adequatly describe these relations (Leopold and Maddock 1953):</p>
<p><span class="math display"><em>T</em><em>W</em> = <em>a</em> ⋅ <em>Q</em><sup><em>b</em></sup></span> <span class="math display"><em>Y</em> = <em>c</em> ⋅ <em>Q</em><sup><em>f</em></sup></span></p>
<p><span class="math display"><em>V</em> = <em>k</em> ⋅ <em>Q</em><sup><em>m</em></sup></span></p>
<p>Each <strong>single relationships</strong> describes a component of the channel behavior (see section <a href="#fitting-single-relationships">Fitting single relationships</a>). For example, the Q-Y relation is similar to the <strong>traditional rating curve</strong> that relates stage to discharge where stage is given as a height of water (H) above a datum (Ho).</p>
<p><span class="math display"><em>Q</em> = <em>c</em> ⋅ (<em>H</em>−<em>H</em><sub><em>o</em></sub>)<sup><em>f</em></sup></span></p>
<p>Traditionally, each relationship has been fit independent of one another using ordinary least square regression (OLS) on the log transformed time series of the respective components.</p>
<p>Some research has moved beyond pure OLS fitting with a (typically) singular focus on the rating curve relation. For example the Texas Water Resources Institute suggests a non linear least squares regression (NLS) (<a href="https://txwri.github.io/r-manual/stage-discharge.html" class="external-link">here</a>), and Bayesian hierarchical modeling have been shown in other cases to be beneficial ((Hrafnkelsson et al. 2022), R implementation <a href="https://CRAN.R-project.org/package=bdrc" class="external-link">here</a>)</p>
<p>When trying to fit a <strong>hydraulic system</strong> - or - all three equations - there are additional considerations . Notably continuity dictates that no water is gained or lost such that:</p>
<p><span class="math display"><em>Q</em> = <em>T</em><em>W</em> · <em>Y</em> · <em>V</em></span></p>
<p>and:</p>
<p><span class="math display">(<em>b</em>+<em>f</em>+<em>m</em>) = (<em>a</em>·<em>c</em>·<em>k</em>) = 1</span></p>
<p><strong>Critically, neither OLS or NLS solvers can ensure this characteristic of the solution.</strong> (see <a href="#fitting-hydraulic-systems">Fitting hydraulic systems</a>). Instead, this can be achieved by either</p>
<ol style="list-style-type: decimal">
<li>Preprocessing data based on thresholds (see Enzminger, Minear, and Livneh (2023) and Afshari et al. (2017)) (see AHGestimation functions in <a href="https://mikejohnson51.github.io/AHGestimation/articles/data-filtering.html" class="external-link">here</a>), or</li>
<li>as we suggest in this package, using a evolutionary solver - along with OLS and NLS fits - to optimally solve relationships in accordance with each other (see detailed description <a href="https://mikejohnson51.github.io/AHGestimation/articles/improved-ahg.html" class="external-link">here</a>).</li>
</ol>
<p>The aim of this package is to provide increased AHG fitting flexibility, that ensures mass conservation in hydraulic systems, and optimal curve fitting for single relations.</p>
</div>
<div class="section level1">
<h1 id="ahgestimation">AHGestimation<a class="anchor" aria-label="anchor" href="#ahgestimation"></a>
</h1>
<p>Using USGS field measurements at the gage located on <a href="https://waterdata.usgs.gov/nwis/measurements/?site_no=01096500&amp;agency_cd=USGS" class="external-link">Nashua River at East Pepperell, MA</a> we can illustrate 4 capabilities this package offers:</p>
<ol style="list-style-type: decimal">
<li>Fitting single relations with OLS and NLS (<a href="#fitting-single-relationships">Fitting single relationships</a>)</li>
<li>Estimating hydraulic system with a mass conserving ensemble fitting method (<a href="#fitting-hydraulic-systems">Fitting hydraulic systems</a>)</li>
<li>Data preprocessing (removing outliers based on defined criteria) (<a href="#data-filtering">Data Filtering</a>)</li>
<li>Deriving cross section shapes and traits from the AHG fits (<a href="#hydraulic-shape-estimation">Hydraulic Shape Estimation</a>).</li>
</ol>
<p>The example data is included in the package, and its development can be seen <a href="https://github.com/mikejohnson51/AHGestimation/blob/master/data-raw/nwis.R" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mikejohnson51/AHGestimation" class="external-link">AHGestimation</a></span><span class="op">)</span></span>
<span><span class="fu">glimpse</span><span class="op">(</span><span class="va">nwis</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 275</span></span>
<span><span class="co">#&gt; Columns: 6</span></span>
<span><span class="co">#&gt; $ siteID &lt;chr&gt; "01096500", "01096500", "01096500", "01096500", "01096500", "01…</span></span>
<span><span class="co">#&gt; $ date   &lt;date&gt; 1984-11-14, 1985-01-04, 1985-05-06, 1985-06-26, 1986-01-09, 19…</span></span>
<span><span class="co">#&gt; $ Q_cms  &lt;dbl&gt; 9.740995, 11.893076, 10.817036, 1.945367, 11.355056, 21.435853,…</span></span>
<span><span class="co">#&gt; $ Y_m    &lt;dbl&gt; 0.5276643, 0.6263470, 0.5952224, 0.2400299, 0.5920151, 0.857459…</span></span>
<span><span class="co">#&gt; $ V_ms   &lt;dbl&gt; 0.652272, 0.682752, 0.563880, 0.332232, 0.606552, 0.902208, 0.4…</span></span>
<span><span class="co">#&gt; $ TW_m   &lt;dbl&gt; 28.3464, 27.7368, 32.3088, 24.3840, 31.6992, 27.7368, 31.6992, …</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-4-1.jpeg" width="100%"></p>
<div class="section level2">
<h2 id="fitting-single-relationships">Fitting single relationships<a class="anchor" aria-label="anchor" href="#fitting-single-relationships"></a>
</h2>
<p>The <code>AHGestimation::ahg_estimate(...)</code> function can be used to fit single relationships using both NLS and OLS solutions. Below we fit the Q-Y relation by passing a <code>data.frame</code> with the column names <code>Q</code> and <code>Y</code>. More columns could be included in the input, but only those with <code>Q</code>, <code>Y</code>, <code>V</code>, and/or <code>TW</code> are used.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">sf</span> <span class="op">=</span> <span class="va">nwis</span> <span class="op">%&gt;%</span></span>
<span>   <span class="co">#input column names must be Q,Y,V and/or TW</span></span>
<span>   <span class="fu">select</span><span class="op">(</span><span class="va">date</span>, Q <span class="op">=</span> <span class="va">Q_cms</span>, Y <span class="op">=</span> <span class="va">Y_m</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>   <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   type       exp      coef nrmse    pb method</span></span>
<span><span class="co">#&gt; 1    Y 0.5190562 0.1867125  7.90 -0.23    nls</span></span>
<span><span class="co">#&gt; 2    Y 0.4794202 0.2018376  8.11 -5.58    ols</span></span></code></pre></div>
<p>The returned object rank sorts the solutions based on the nrmse of the simulated Y values compared to the input data. For convenience, the pBias is also reported. Below, we can see the variation in the NLS (blue) and OLS (red) solutions.</p>
<p><img src="reference/figures/README-unnamed-chunk-6-1.jpeg" width="100%"></p>
<p>When 2 relationships (e.g. Q-Y and Q-V) are passed to <code>ahg_estimate(...)</code> the default behavior is to return a single solution based on the minimum nrmse. Since only 2 of the 3 hydraulic traits are passed, mass conservation cannot be checked here.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nwis</span> <span class="op">%&gt;%</span></span>
<span>   <span class="co">#input column names must be Q,Y,V and/or TW</span></span>
<span>   <span class="fu">select</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q_cms</span>, Y <span class="op">=</span> <span class="va">Y_m</span>, V <span class="op">=</span> <span class="va">V_ms</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>   <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   V_method Y_method tot_nrmse   V_nrmse   Y_nrmse   V_coef    Y_coef     V_exp</span></span>
<span><span class="co">#&gt; 1      nls      nls 0.6787807 0.2312688 0.4475119 0.289889 0.1867125 0.3246968</span></span>
<span><span class="co">#&gt;       Y_exp</span></span>
<span><span class="co">#&gt; 1 0.5190562</span></span></code></pre></div>
<p>If you would like all fits (OLS and NLS), the <code>full_fitting</code> parameter can be set to <code>TRUE</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nwis</span> <span class="op">%&gt;%</span></span>
<span>   <span class="co">#input column names must be Q,Y,V and/or TW</span></span>
<span>   <span class="fu">select</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q_cms</span>, Y <span class="op">=</span> <span class="va">Y_m</span>, V <span class="op">=</span> <span class="va">V_ms</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>   <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span>full_fitting <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $full_fits</span></span>
<span><span class="co">#&gt;   V_method Y_method tot_nrmse   V_nrmse   Y_nrmse    V_coef    Y_coef     V_exp</span></span>
<span><span class="co">#&gt; 1      nls      nls 0.6787807 0.2312688 0.4475119 0.2898890 0.1867125 0.3246968</span></span>
<span><span class="co">#&gt; 2      ols      ols 0.7127124 0.2534246 0.4592878 0.2178592 0.2018376 0.4056932</span></span>
<span><span class="co">#&gt;       Y_exp</span></span>
<span><span class="co">#&gt; 1 0.5190562</span></span>
<span><span class="co">#&gt; 2 0.4794202</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $summary</span></span>
<span><span class="co">#&gt;   V_method Y_method tot_nrmse   V_nrmse   Y_nrmse   V_coef    Y_coef     V_exp</span></span>
<span><span class="co">#&gt; 1      nls      nls 0.6787807 0.2312688 0.4475119 0.289889 0.1867125 0.3246968</span></span>
<span><span class="co">#&gt;       Y_exp</span></span>
<span><span class="co">#&gt; 1 0.5190562</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fitting-hydraulic-systems">Fitting hydraulic systems<a class="anchor" aria-label="anchor" href="#fitting-hydraulic-systems"></a>
</h2>
<p>When we have data for all three hydraulic relationships we can ensure the solutions found meet continuity/conserve mass.</p>
<p>In this mode the OLS and NLS models are fit first, and if continuity is not met in best solution (e.g. lowest nmse), then an Evolutionary Approach (nsga2; Mersmann (2020)) is implemented.</p>
<p>Doing so produces three unique fits for each relationship (27 total combinations). These are crossed to identify the best performing solution that meets continuity at a prescribed allowance. The allowance specifies the amount that each continuity expression can deviate from 1. More on this can be found at the vignette <a href="https://mikejohnson51.github.io/AHGestimation/articles/improved-ahg.html" class="external-link">here</a></p>
<p>As before, the results are rank ordered by minimum nrmse and viability (viable = does the solution meet continuity within the prescribed allowance?)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="va">nwis</span> <span class="op">%&gt;%</span> </span>
<span>   <span class="fu">select</span><span class="op">(</span>Q <span class="op">=</span> <span class="va">Q_cms</span>, Y <span class="op">=</span> <span class="va">Y_m</span>, V <span class="op">=</span> <span class="va">V_ms</span>, TW <span class="op">=</span> <span class="va">TW_m</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>   <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span>allowance <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   V_method TW_method Y_method    c1    c2 viable tot_nrmse   V_nrmse  TW_nrmse</span></span>
<span><span class="co">#&gt; 1      nls       nls    nsga2 1.048 0.997   TRUE 0.8478575 0.2312688 0.1665577</span></span>
<span><span class="co">#&gt; 2    nsga2     nsga2    nsga2 1.042 0.997   TRUE 0.8480158 0.2314216 0.1665631</span></span>
<span><span class="co">#&gt; 3      ols       ols      ols 0.994 1.000   TRUE 0.8799006 0.2534246 0.1671882</span></span>
<span><span class="co">#&gt; 4      nls       nls      nls 1.234 0.960  FALSE 0.8453383 0.2312688 0.1665577</span></span>
<span><span class="co">#&gt;     Y_nrmse    V_coef  TW_coef    Y_coef     V_exp    TW_exp     Y_exp</span></span>
<span><span class="co">#&gt; 1 0.4500311 0.2898890 22.79344 0.1586042 0.3246968 0.1166774 0.5560598</span></span>
<span><span class="co">#&gt; 2 0.4500311 0.2874600 22.86035 0.1586042 0.3248796 0.1160671 0.5560598</span></span>
<span><span class="co">#&gt; 3 0.4592878 0.2178592 22.61538 0.2018376 0.4056932 0.1145234 0.4794202</span></span>
<span><span class="co">#&gt; 4 0.4475119 0.2898890 22.79344 0.1867125 0.3246968 0.1166774 0.5190562</span></span>
<span><span class="co">#&gt;   condition</span></span>
<span><span class="co">#&gt; 1 bestValid</span></span>
<span><span class="co">#&gt; 2     nsga2</span></span>
<span><span class="co">#&gt; 3       ols</span></span>
<span><span class="co">#&gt; 4       nls</span></span></code></pre></div>
<p>Overall an combination of the NLS and nsga2 provides an error minimizing, viable solution:</p>
<p><img src="reference/figures/README-unnamed-chunk-10-1.jpeg" width="100%"></p>
</div>
<div class="section level2">
<h2 id="data-filtering">Data Filtering<a class="anchor" aria-label="anchor" href="#data-filtering"></a>
</h2>
<p>Due to the volatility of river systems, hydraulic data is often very noisy. While the <code>ahg_estimate</code> tool is intended to reduce this noise and produce a mass-conserving hydraulic fit, it is also possible to filter the data prior to fitting. The range of data filtering options provided are documented in the <a href="https://mikejohnson51.github.io/AHGestimation/articles/data-filtering.html" class="external-link">data-filtering vignette</a> and an example is provided below:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filtered_data</span> <span class="op">=</span> <span class="va">nwis</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">date</span>, Q <span class="op">=</span> <span class="va">Q_cms</span>, Y <span class="op">=</span> <span class="va">Y_m</span>, V <span class="op">=</span> <span class="va">V_ms</span>, TW <span class="op">=</span> <span class="va">TW_m</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Keep the most recent 10 year</span></span>
<span>  <span class="fu"><a href="reference/date_filter.html">date_filter</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">10</span>, keep_max <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Keep data within 3 Median absolute deviations (log residuals)</span></span>
<span>  <span class="fu"><a href="reference/mad_filter.html">mad_filter</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Keep data that respects the Q = vA criteria w/in allowance</span></span>
<span>  <span class="fu"><a href="reference/qva_filter.html">qva_filter</a></span><span class="op">(</span><span class="op">)</span></span>
<span> </span>
<span><span class="op">(</span><span class="va">ahg_fit</span> <span class="op">=</span> <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span><span class="va">filtered_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   V_method TW_method Y_method    c1 c2 viable tot_nrmse   V_nrmse  TW_nrmse</span></span>
<span><span class="co">#&gt; 1      nls       nls      nls 1.012  1   TRUE 0.3443460 0.1434527 0.1022593</span></span>
<span><span class="co">#&gt; 2      nls       nls      nls 1.012  1   TRUE 0.3443460 0.1434527 0.1022593</span></span>
<span><span class="co">#&gt; 3      ols       ols      ols 0.998  1   TRUE 0.4456573 0.1908811 0.1039403</span></span>
<span><span class="co">#&gt;      Y_nrmse    V_coef  TW_coef    Y_coef     V_exp    TW_exp     Y_exp</span></span>
<span><span class="co">#&gt; 1 0.09863406 0.2812859 18.50099 0.1945125 0.3181974 0.1717161 0.5099640</span></span>
<span><span class="co">#&gt; 2 0.09863406 0.2812859 18.50099 0.1945125 0.3181974 0.1717161 0.5099640</span></span>
<span><span class="co">#&gt; 3 0.15083589 0.2099045 19.19159 0.2478285 0.4124677 0.1567236 0.4312825</span></span>
<span><span class="co">#&gt;   condition</span></span>
<span><span class="co">#&gt; 1 bestValid</span></span>
<span><span class="co">#&gt; 2       nls</span></span>
<span><span class="co">#&gt; 3       ols</span></span></code></pre></div>
<p>When the data is effectively filtered we see NLS can provide an error minimizing, valid solution for the system that is quite different then the full data fit. Further, the nsga2 algorithm did not need to be invoked:</p>
<p><img src="reference/figures/README-unnamed-chunk-12-1.jpeg" width="100%"></p>
</div>
<div class="section level2">
<h2 id="hydraulic-shape-estimation">Hydraulic Shape Estimation<a class="anchor" aria-label="anchor" href="#hydraulic-shape-estimation"></a>
</h2>
<p>Lastly, a range of functions have been added to extend the AHG parameters into cross section hydraulics and geometry. These come primarily from (Dingman and Afshari 2018) and are described in detail <a href="https://mikejohnson51.github.io/AHGestimation/articles/hydraulics.html" class="external-link">here</a></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute hydraulic parameters</span></span>
<span><span class="op">(</span><span class="va">hydraulic_params</span> <span class="op">=</span> <span class="fu"><a href="reference/compute_hydraulic_params.html">compute_hydraulic_params</a></span><span class="op">(</span><span class="va">ahg_fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;          r         p        d        R        bd        fd        md</span></span>
<span><span class="co">#&gt; 1 2.969809 0.6239605 5.822852 1.336722 0.1717371 0.5100265 0.3182364</span></span>
<span><span class="co">#&gt; 2 2.969809 0.6239605 5.822852 1.336722 0.1717371 0.5100265 0.3182364</span></span>
<span><span class="co">#&gt; 3 2.751866 0.9563746 6.383682 1.363390 0.1566494 0.4310783 0.4122723</span></span>
<span></span>
<span><span class="co"># Estimate roughness</span></span>
<span><span class="co"># Slope is taken from the NHD reach associated with our gage</span></span>
<span><span class="fu"><a href="reference/compute_n.html">compute_n</a></span><span class="op">(</span><span class="va">filtered_data</span>, S <span class="op">=</span> <span class="fl">0.01463675</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.1385395</span></span></code></pre></div>
<p>Of particular note, the <code>r</code> value describes the theoretical shape of the channel ranging from a triangle (r = 1) to a rectangle (r = ∞). When paired with a TW and Depth (here assuming max of the record) a generalized cross section can be derived. The returned data.frame provide a point index (from left bank looking upstream) the associated relative x and absolute Y position, and the cross sectional area for that Y.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cs</span> <span class="op">=</span> <span class="fu"><a href="reference/cross_section.html">cross_section</a></span><span class="op">(</span>r <span class="op">=</span> <span class="va">hydraulic_params</span><span class="op">$</span><span class="va">r</span>,  </span>
<span>                   TW   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">TW</span><span class="op">)</span>, </span>
<span>                   Ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">glimpse</span><span class="op">(</span><span class="va">cs</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 150</span></span>
<span><span class="co">#&gt; Columns: 4</span></span>
<span><span class="co">#&gt; $ ind &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19,…</span></span>
<span><span class="co">#&gt; $ x   &lt;dbl&gt; 0.0000000, 0.3422819, 0.6845638, 1.0268456, 1.3691275, 1.7114094, …</span></span>
<span><span class="co">#&gt; $ Y   &lt;dbl&gt; 3.565485, 3.550130, 3.550130, 3.186628, 3.144801, 3.144801, 2.8344…</span></span>
<span><span class="co">#&gt; $ A   &lt;dbl&gt; 132.46010, 131.56309, 131.56309, 113.75671, 111.63183, 111.63183, …</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-15-1.jpeg" width="100%"></p>
</div>
</div>
<div class="section level1">
<h1 id="history">History<a class="anchor" aria-label="anchor" href="#history"></a>
</h1>
<p>The development of this package began as a graduate school project between friends at UC Santa Barbara and UMass Amherst following the 2017 NOAA OWP Summer Institute and clear evidence channel shape may be a limiting factor in National Water Model Performance. It has since evolved to provide an open source utility for robust large scale data synthesis and evaluation. Funding from the National Science Foundation (Grants 1937099, 2033607) provided time to draft Johnson (2022) and apply an early version of this software to the [Continental Flood Inundation Mapping (CFIM) synthetic rating curve dataset (Liu and Maidment 2020). Funding from the National Oceanic and Atmospheric Administration’s Office of Water Prediction supported the addition of data filtering and hydraulic estimation, improved documentation, and code improvement We are grateful to all involved.</p>
</div>
<div class="section level1">
<h1 id="contributing">Contributing<a class="anchor" aria-label="anchor" href="#contributing"></a>
</h1>
<p>First, thanks for considering a contribution! We hope to make this package a community created resource!</p>
<ul>
<li>Please attempt to describe what you want to do prior to contributing by submitting an issue.</li>
<li>Please follow the typical github fork - pull-request workflow.</li>
<li>Contributions should be tested with <code>testthat</code> by running <code><a href="https://devtools.r-lib.org/reference/test.html" class="external-link">devtools::test()</a></code>.</li>
<li>Code style should attempt to follow the <a href="https://style.tidyverse.org/" class="external-link">tidyverse style guide</a>.</li>
<li>Make sure you use <code>roxygen</code> and run <code><a href="https://devtools.r-lib.org/reference/check.html" class="external-link">devtools::check()</a></code> before contributing.</li>
</ul>
<p>Other notes:</p>
<ul>
<li>Consider running <code><a href="https://rdrr.io/pkg/goodpractice/man/gp.html" class="external-link">goodpractice::gp()</a></code> on the package before contributing.</li>
<li>Consider running <code><a href="https://devtools.r-lib.org/reference/spell_check.html" class="external-link">devtools::spell_check()</a></code> and <code><a href="https://devtools.r-lib.org/reference/document.html" class="external-link">devtools::document()</a></code> if you wrote documentation.</li>
<li>Consider running <code><a href="https://devtools.r-lib.org/reference/build_rmd.html" class="external-link">devtools::build_readme()</a></code> if you made any changes.</li>
<li>This package uses pkgdown. Running <code><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">pkgdown::build_site()</a></code> will refresh it.</li>
</ul>
</div>
<div class="section level1">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-afshari2017statistical" class="csl-entry">
Afshari, Shahab, Balazs M Fekete, S Lawrence Dingman, Naresh Devineni, David M Bjerklie, and Reza M Khanbilvardi. 2017. “Statistical Filtering of River Survey and Streamflow Data for Improving at-a-Station Hydraulic Geometry Relations.” <em>Journal of Hydrology</em> 547: 443–54. <a href="https://doi.org/10.1016/j.jhydrol.2017.01.038" class="external-link uri">https://doi.org/10.1016/j.jhydrol.2017.01.038</a>.
</div>
<div id="ref-dingman2018field" class="csl-entry">
Dingman, S Lawrence, and Shahab Afshari. 2018. “Field Verification of Analytical at-a-Station Hydraulic-Geometry Relations.” <em>Journal of Hydrology</em> 564: 859–72. <a href="https://doi.org/10.1002/aaai.12035" class="external-link uri">https://doi.org/10.1002/aaai.12035</a>.
</div>
<div id="ref-enzminger_thomas_l_2023_7868764" class="csl-entry">
Enzminger, Thomas L., J. Toby Minear, and Ben Livneh. 2023. “<span class="nocase">HyG: A hydraulic geometry dataset derived from historical stream gage measurements across the conterminous United States</span>.” Zenodo. <a href="https://doi.org/10.5281/zenodo.7868764" class="external-link uri">https://doi.org/10.5281/zenodo.7868764</a>.
</div>
<div id="ref-hrafnkelsson2022generalization" class="csl-entry">
Hrafnkelsson, Birgir, Helgi Sigurdarson, Sölvi Rögnvaldsson, Axel Örn Jansson, Rafael Danı́el Vias, and Sigurdur M Gardarsson. 2022. “Generalization of the Power-Law Rating Curve Using Hydrodynamic Theory and Bayesian Hierarchical Modeling.” <em>Environmetrics</em> 33 (2): e2711.
</div>
<div id="ref-preprint" class="csl-entry">
Johnson, J.; Clarke, J. M.; Coll. 2022. <em>Determining Feature Based Hydraulic Geometry and Rating Curves Using a Physically Based, Computationally Efficient Framework</em>. <em>Preprints</em>. <a href="https://doi.org/10.20944/preprints202212.0390.v1" class="external-link uri">https://doi.org/10.20944/preprints202212.0390.v1</a>.
</div>
<div id="ref-leopold1953hydraulic" class="csl-entry">
Leopold, Luna Bergere, and Thomas Maddock. 1953. <em>The Hydraulic Geometry of Stream Channels and Some Physiographic Implications</em>. Vol. 252. US Government Printing Office. <a href="https://doi.org/10.3133/pp252" class="external-link uri">https://doi.org/10.3133/pp252</a>.
</div>
<div id="ref-cfim" class="csl-entry">
Liu, Tarboton, Yan Y., and David R. Maidment. 2020. <em>Height Above Nearest Drainage (HAND) and Hydraulic Property Table for CONUS - Version 0.2.1. (20200601)</em>. <em>Oak Ridge Leadership Computing Facility.</em> <a href="https://cfim.ornl.gov/data/" class="external-link uri">https://cfim.ornl.gov/data/</a>.
</div>
<div id="ref-mco" class="csl-entry">
Mersmann, Olaf. 2020. <em>Mco: Multiple Criteria Optimization Algorithms and Related Functions</em>. <a href="https://CRAN.R-project.org/package=mco" class="external-link uri">https://CRAN.R-project.org/package=mco</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/mikejohnson51/AHGestimation/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/mikejohnson51/AHGestimation/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing AHGestimation</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Mike Johnson <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-5288-8350" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Arash Modaresi Rad <br><small class="roles"> Contributor </small> <a href="https://orcid.org/0000-0002-6030-7923" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>
<a href="https://water.noaa.gov/" class="external-link"><img src="reference/figures/noaa-logo.png" width="72" alt="NOAA OWP"></a> <br><small class="roles"> Funder </small>  </li>
<li>
<a href="https://www.nsf.gov/" class="external-link"><img src="reference/figures/nsf-logo.png" width="72" alt="NSF"></a> <br><small class="roles"> Funder </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mike Johnson, Arash Modaresi Rad.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
