<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Compute AHG fits from river measurements.">
<title>Computing robust, mass preserving hydraulic geometries and rating curves • AHGestimation</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Computing robust, mass preserving hydraulic geometries and rating curves">
<meta property="og:description" content="Compute AHG fits from river measurements.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">AHGestimation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="articles/index.html">Articles</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mikejohnson51/AHGestimation/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="ahgestimation">AHGestimation<a class="anchor" aria-label="anchor" href="#ahgestimation"></a>
</h1></div>
<blockquote>
<p><strong><em>Citation:</em></strong> Johnson, J.M. (2022) AHGestimation: Tools for Estimating Physically-Based, Computationally Efficient Feature Based Hydraulic Geometry and Rating Curves.</p>
</blockquote>
<p>Using data from the USGS manual measurement (Johnson, 2018), we can illustrate the utilities in this package. Overall this package provides 4 capabilities:</p>
<ol style="list-style-type: decimal">
<li>Single Relation fits</li>
<li>Full hydraulic system fits</li>
<li>Data preprocessing</li>
<li>Derivation of cross sections and additional hydraulic traits</li>
</ol>
<div class="section level2">
<h2 id="base-data">Base data<a class="anchor" aria-label="anchor" href="#base-data"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mikejohnson51/AHGestimation" class="external-link">AHGestimation</a></span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu">AHGestimation</span><span class="fu">::</span><span class="va"><a href="reference/nwis.html">nwis</a></span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-3-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="single-relationship-fits">Single Relationship fits<a class="anchor" aria-label="anchor" href="#single-relationship-fits"></a>
</h2>
<p>Here we use the <code>AHGestimation</code> package to fit the Q-Y relationship using OLS and NLS models:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">sf</span> <span class="op">=</span> <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fu">select</span><span class="op">(</span><span class="va">data</span>, <span class="va">Q</span>, <span class="va">Y</span><span class="op">)</span>, allowance <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   type       exp      coef nrmse    pb method</span></span>
<span><span class="co">#&gt; 1    Y 0.5185496 0.1871979  8.35 -0.18    nls</span></span>
<span><span class="co">#&gt; 2    Y 0.4797009 0.2004177  8.58 -6.19    ols</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-5-1.png" width="100%"></p>
<p>Overall the the NLS model provides a better fit (albeit small) when measured both by nRMSE and pBais.</p>
</div>
<div class="section level2">
<h2 id="full-hydraulic-fits">Full Hydraulic fits<a class="anchor" aria-label="anchor" href="#full-hydraulic-fits"></a>
</h2>
<p>When we have data regarding three hydraulic states (V,TW,Y) we can ensure that the solutions found are physically valid (meets the continuity constraint Q = Y x V x TW).</p>
<p>In this mode the OLS and NLS models are fit, and if continuity is not met, then a Evolutionary Approach is implemented. Doing so produces three unique fits for three variables (27 total combinations). These are crossed to identify the best performing relationships that meet continuity at a prescribed allowance:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span><span class="va">data</span>, allowance <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   V_method TW_method Y_method viable tot_error   V_error  TW_error   Y_error</span></span>
<span><span class="co">#&gt; 1    nsga2       nls    nsga2   TRUE 0.8363382 0.2415419 0.1708646 0.4239317</span></span>
<span><span class="co">#&gt; 2    nsga2     nsga2    nsga2   TRUE 0.8363637 0.2415419 0.1708902 0.4239317</span></span>
<span><span class="co">#&gt; 3      ols       ols      ols   TRUE 0.8686964 0.2641997 0.1715093 0.4329873</span></span>
<span><span class="co">#&gt; 4      nls       nls      nls  FALSE 0.8336534 0.2412345 0.1708646 0.4215543</span></span>
<span><span class="co">#&gt;      V_coef  TW_coef    Y_coef     V_exp    TW_exp     Y_exp condition</span></span>
<span><span class="co">#&gt; 1 0.2803454 23.30572 0.1577947 0.3329645 0.1111103 0.5570045 bestValid</span></span>
<span><span class="co">#&gt; 2 0.2803454 23.31637 0.1577947 0.3329645 0.1100569 0.5570045     nsga2</span></span>
<span><span class="co">#&gt; 3 0.2155711 23.01003 0.2004177 0.4093273 0.1104173 0.4797009       ols</span></span>
<span><span class="co">#&gt; 4 0.2886315 23.30572 0.1871979 0.3273010 0.1111103 0.5185496       nls</span></span></code></pre></div>
<p>Overall an combination of the OLS and NLS fit are able to provide a error minimizing solution:</p>
<p><img src="reference/figures/README-unnamed-chunk-7-1.png" width="100%"></p>
<p>In the above example we see that NLS was able to provide better fits the OLS but neither NLS or OLS was able to provide physically valid solutions (viable). While the nsga2 approach was able to provide a physically valid solution, its error was almost 10% higher then the OLS/NLS methods.</p>
<p>However a combined approach of a NLS, OLS, and nsga2 was able to provide a physically valid result with only 0.03% more error the seen in the best performing NLS method.</p>
<p>** This was all done using raw, unrefined data! **</p>
</div>
<div class="section level2">
<h2 id="data-filtering">Data Filtering<a class="anchor" aria-label="anchor" href="#data-filtering"></a>
</h2>
<p>Due to the volatility of river systems and deviations in measurement techniques and accuracy hydraulic data is often very noisy. While the <code>ahg_estimation</code> tool is intended to reduce this noise and produce a mass-conserving hydraulic fit, it is also possible to filter the data prior to fitting. The range of data filtering options provided are documented in the data-filtering vignette and an example is provided below:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">xf</span> <span class="op">=</span> <span class="va">data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Keep the most recent 10 year</span></span>
<span>  <span class="fu"><a href="reference/date_filter.html">date_filter</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">10</span>, keep_max <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Keep data within 3 Median absolute deviations (log residuals)</span></span>
<span>  <span class="fu"><a href="reference/mad_filter.html">mad_filter</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="co"># Keep data that respects the Q = vA criteria w/in allowance</span></span>
<span>  <span class="fu"><a href="reference/qva_filter.html">qva_filter</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   V_method TW_method Y_method viable tot_error   V_error  TW_error    Y_error</span></span>
<span><span class="co">#&gt; 1      nls       nls      nls   TRUE 0.3868315 0.1737420 0.1235461 0.08954336</span></span>
<span><span class="co">#&gt; 2      nls       nls      nls   TRUE 0.3868315 0.1737420 0.1235461 0.08954336</span></span>
<span><span class="co">#&gt; 3      ols       ols      ols   TRUE 0.4869776 0.2216127 0.1255148 0.13985007</span></span>
<span><span class="co">#&gt;      V_coef  TW_coef    Y_coef     V_exp    TW_exp     Y_exp condition</span></span>
<span><span class="co">#&gt; 1 0.2938667 17.98606 0.1934940 0.3009787 0.1874598 0.5098970 bestValid</span></span>
<span><span class="co">#&gt; 2 0.2938667 17.98606 0.1934940 0.3009787 0.1874598 0.5098970       nls</span></span>
<span><span class="co">#&gt; 3 0.2204190 18.53150 0.2448765 0.3941493 0.1733737 0.4322574       ols</span></span></code></pre></div>
<p>When the data is effectively filtered we see NLS can provide an error minimizing, valid solution for the system that is quite different then the full data fit:</p>
<p><img src="reference/figures/README-unnamed-chunk-9-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="hydraulic-estimation">Hydraulic Estimation<a class="anchor" aria-label="anchor" href="#hydraulic-estimation"></a>
</h2>
<p>Lastly, a range of functions have been added to extend the AHG parameters into cross section hydraulics and geometry:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filter_data</span> <span class="op">=</span> <span class="va">data</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="reference/date_filter.html">date_filter</a></span><span class="op">(</span><span class="fl">10</span>, keep_max <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="reference/nls_filter.html">nls_filter</a></span><span class="op">(</span>allowance <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">ahg_fit</span> <span class="op">=</span> <span class="fu"><a href="reference/ahg_estimate.html">ahg_estimate</a></span><span class="op">(</span><span class="va">filter_data</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span></span>
<span></span>
<span><span class="op">(</span><span class="va">shape</span> <span class="op">=</span> <span class="fu"><a href="reference/compute_hydraulic_params.html">compute_hydraulic_params</a></span><span class="op">(</span><span class="va">ahg_fit</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;          r         p        d        R        bd        fd        md</span></span>
<span><span class="co">#&gt; 1 2.749318 0.6103574 5.427385 1.363727 0.1842508 0.5065641 0.3091851</span></span>
<span></span>
<span><span class="va">cs</span> <span class="op">=</span> <span class="fu"><a href="reference/cross_section.html">cross_section</a></span><span class="op">(</span>r <span class="op">=</span> <span class="va">shape</span><span class="op">$</span><span class="va">r</span>,  </span>
<span>                   TW <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">filter_data</span><span class="op">$</span><span class="va">TW</span><span class="op">)</span>, </span>
<span>                   Ymax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">filter_data</span><span class="op">$</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">glimpse</span><span class="op">(</span><span class="va">cs</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 50</span></span>
<span><span class="co">#&gt; Columns: 4</span></span>
<span><span class="co">#&gt; $ ind &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19,…</span></span>
<span><span class="co">#&gt; $ x   &lt;dbl&gt; 0.000000, 1.040816, 2.081633, 3.122449, 4.163265, 5.204082, 6.2448…</span></span>
<span><span class="co">#&gt; $ Y   &lt;dbl&gt; 3.5656665613, 3.1871221498, 2.8351885546, 2.5090304653, 2.20780341…</span></span>
<span><span class="co">#&gt; $ A   &lt;dbl&gt; 1.318953e+02, 1.130112e+02, 9.618829e+01, 8.127753e+01, 6.813466e+…</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-11-1.png" width="100%"></p>
</div>
</div>
<div class="section level1">
<h1 id="history">History<a class="anchor" aria-label="anchor" href="#history"></a>
</h1>
<p>The development of this package began as a graduate school project between friends at UC Santa Barbara and UMass Amherst following the 2017 NOAA OWP Summer Institute and clear evidence channel shape may be a limiting factor in National Water Model Performance. It has since evolved to provide an open source utility for robust large scale data synthesis and evaluation. Funding from the National Science Foundation (Grants 1937099, 2033607) provided time to draft the <a href="https://www.preprints.org/manuscript/202212.0390/v1" class="external-link">preprint here</a> and apply an early version of this software to the <a href="https://cfim.ornl.gov/data/" class="external-link">Continental Flood Inundation Mapping (CFIM)</a> synthetic rating curve dataset. Funding from the National Oceanic and Atmospheric Administration’s Office of Water Prediction supported the addition of data filtering and hydraulic estimation, improved documentation, and code hardening. We are grateful to all involved.</p>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/mikejohnson51/AHGestimation/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/mikejohnson51/AHGestimation/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing AHGestimation</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Mike Johnson <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-5288-8350" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Arash Modaresi Rad <br><small class="roles"> Contributor </small> <a href="https://orcid.org/0000-0002-6030-7923" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>
<a href="https://water.noaa.gov/" class="external-link"><img src="reference/figures/noaa-logo.png" width="72" alt="NOAA OWP"></a> <br><small class="roles"> Funder </small>  </li>
<li>
<a href="https://www.nsf.gov/" class="external-link"><img src="reference/figures/nsf-logo.png" width="72" alt="NSF"></a> <br><small class="roles"> Funder </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mike Johnson, Arash Modaresi Rad.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
